// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Car {
  id            Int           @id @default(autoincrement())
  
  // Basic Information
  brand         String
  model         String
  plate         String        @unique
  year          Int
  color         String
  
  // Technical Specifications
  fuelType      String        // Benzin, Diesel, Elektro, Hybrid, Plug-in Hybrid
  transmission  String?       // Automatik, Manuell
  category      String?       // Kleinwagen, Mittelklasse, SUV, Limousine, Kombi, Van, Sportwagen, Cabrio
  doors         Int?          // Number of doors
  seats         Int?          // Number of seats
  engineSize    String?       // e.g., "2.0L", "1.6L"
  horsePower    Int?          // PS
  fuelConsumption String?     // L/100km or kWh/100km
  co2Emission   String?       // g/km
  
  // Status & Identification
  status        String        // Active, Maintenance, Rented, Reserved, Inactive
  vin           String?       @unique // Vehicle Identification Number (17 chars)
  chassisNumber String?
  
  // Pricing
  dailyRate         Decimal
  weeklyRate        Decimal?
  monthlyRate       Decimal?
  longTermRate      Decimal?
  minDaysForLongTerm Int?
  depositAmount     Decimal?
  
  // Promotional Pricing
  promoPrice        Decimal?
  promoStartDate    DateTime?
  promoEndDate      DateTime?
  
  // Insurance & Documents
  insuranceCompany  String?
  insurancePolicyNumber String?
  insuranceValidUntil DateTime?
  registrationDate  DateTime?
  nextInspection    DateTime?    // TÜV/HU
  
  // Mileage & Usage
  currentMileage    Int?         // in km
  purchaseMileage   Int?
  maxMileagePerDay  Int?         // km limit per rental day
  
  // Content & Media
  imageUrl          String?
  images            String?      // JSON array of image URLs
  description       String?
  features          String?      // Comma separated: GPS, Klimaanlage, Sitzheizung, etc.
  
  // Equipment & Features (Boolean flags for common features)
  hasAirConditioning Boolean @default(false)
  hasGPS            Boolean @default(false)
  hasHeatedSeats    Boolean @default(false)
  hasParkingSensors Boolean @default(false)
  hasBackupCamera   Boolean @default(false)
  hasCruiseControl  Boolean @default(false)
  hasBluetoothAudio Boolean @default(false)
  hasUSBPorts       Boolean @default(false)
  hasChildSeatAnchors Boolean @default(false)
  hasSkiRack        Boolean @default(false)
  hasTowHitch       Boolean @default(false)
  
  // Maintenance & Services
  vignetteValidUntil DateTime?
  vignetteType      String?      // Jahresvignette, 2-Monatsvignette, etc.
  lastOilChange     DateTime?
  nextOilChange     DateTime?
  lastTireChange    DateTime?
  tireType          String?      // Sommerreifen, Winterreifen, Allwetter
  nextServiceDate   DateTime?
  lastServiceDate   DateTime?
  
  // Location & Availability
  locationId        Int?
  currentLocation   Location?    @relation("CarLocation", fields: [locationId], references: [id])
  homeLocationId    Int?
  homeLocation      Location?    @relation("CarHomeLocation", fields: [homeLocationId], references: [id])
  
  // Financial
  purchasePrice     Decimal?
  purchaseDate      DateTime?
  currentValue      Decimal?
  
  // Internal Management
  internalNotes     String?
  damageHistory     String?      // JSON or text log
  isActive          Boolean @default(true)
  
  // GPS / Tracking
  latitude          Float?
  longitude         Float?

  // Timestamps
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  // Relations
  rentals       Rental[]
  maintenanceRecords MaintenanceRecord[]
  damageRecords DamageRecord[]
  tasks         Task[]
  fahrtenbuchEntries FahrtenbuchEntry[]
  options       Option[]
}

model CarCategory {
  id        Int     @id @default(autoincrement())
  name      String  @unique
  sortOrder Int     @default(0)
}

model Location {
  id          Int      @id @default(autoincrement())
  name        String
  code        String?  @unique
  address     String?
  city        String?
  country     String?  @default("Deutschland")
  phone       String?
  email       String?
  
  // Coordinates
  latitude    Float?
  longitude   Float?
  
  // Operations
  openingTime String?
  closingTime String?
  isOpenSundays Boolean @default(false)
  
  status      String   @default("active")
  
  cars        Car[]    @relation("CarLocation")
  homeCars    Car[]    @relation("CarHomeLocation")
  
  pickups     Rental[] @relation("PickupLocation")
  returns     Rental[] @relation("ReturnLocation")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model DamageRecord {
  id            Int      @id @default(autoincrement())
  carId         Int
  rentalId      Int?
  
  type          String   // Scratch, Dent, Broken Glass, Missing Part, etc.
  description   String?
  severity      String?  // Low, Medium, High
  
  photoUrl      String?
  locationOnCar String?  // front-left, rear-bumper, roof, etc.
  xPosition     Float?   // X coordinate on the visual blueprint (0-100%)
  yPosition     Float?   // Y coordinate on the visual blueprint (0-100%)
  
  reportedDate  DateTime @default(now())
  status        String   @default("open") // open, repaired, ignored
  repairCost    Decimal?
  
  // Europäischer Unfallbericht (ÖAMTC)
  accidentDate     DateTime?
  accidentTime     String?
  accidentPlace    String?
  accidentCountry  String?   @default("Österreich")
  injuries         Boolean?  @default(false)
  otherPartyDriverName   String?
  otherPartyAddress      String?
  otherPartyPhone        String?
  otherPartyRegistration String?
  otherPartyVehicle      String?
  otherPartyInsurance    String?
  otherPartyPolicyNumber String?
  otherPartyDamage       String?
  witnessName    String?
  witnessAddress String?
  witnessPhone   String?
  circumstances  String?
  sketchNotes    String?
  reportedByCustomerId Int?
  reportedByCustomer   Customer? @relation(fields: [reportedByCustomerId], references: [id])
  
  car           Car      @relation(fields: [carId], references: [id])
  rental        Rental?  @relation(fields: [rentalId], references: [id])
}

/// Finanzamt: Fahrtenbuch pro Fahrzeug (Dienst-/Privatfahrten)
model FahrtenbuchEntry {
  id          Int       @id @default(autoincrement())
  carId       Int
  rentalId    Int?
  datum       DateTime
  startKm     Int
  endKm       Int
  zweck       String    // DIENSTFAHRT | PRIVATFAHRT
  fahrtzweck  String?
  createdAt   DateTime  @default(now())
  car         Car       @relation(fields: [carId], references: [id])
  rental      Rental?   @relation(fields: [rentalId], references: [id])
  @@index([carId, datum])
}

model DiscountCoupon {
  id          Int       @id @default(autoincrement())
  code        String    @unique
  description String?
  
  discountType String   // PERCENTAGE, FIXED_AMOUNT
  discountValue Decimal
  
  validFrom   DateTime?
  validUntil  DateTime?
  
  minOrderAmount Decimal?
  usageLimit     Int?    // Max total usages
  usedCount      Int     @default(0)
  
  isActive    Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Task {
  id            Int      @id @default(autoincrement())
  title         String
  description   String?
  
  priority      String   @default("medium") // low, medium, high, urgent
  status        String   @default("todo")    // todo, in_progress, done
  
  dueDate       DateTime?
  assignedTo    String?  // Username or User ID string
  
  relatedCarId  Int?
  car           Car?     @relation(fields: [relatedCarId], references: [id])
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model OptionGroup {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  options     Option[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Option {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  price       Decimal 
  type        String?  // 'package', 'insurance', 'extra', 'driver'
  
  // New: Car Category tagging for easier selection
  carCategory String?  // e.g. 'Kleinwagen', 'SUV', 'Bus'
  
  // Pricing Rules
  isPerDay    Boolean  @default(false)
  maxPrice    Decimal? // Cap on total cost
  maxDays     Int?     // Charge only for first X days
  
  // Constraints
  isMandatory Boolean  @default(false)
  maxQuantity Int      @default(1)
  
  status      String   @default("active")
  imageUrl    String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  groupId     Int?
  group       OptionGroup? @relation(fields: [groupId], references: [id])
  carId       Int?
  car         Car?         @relation(fields: [carId], references: [id], onDelete: Cascade)
}


model Customer {
  id            Int           @id @default(autoincrement())
  firstName     String
  lastName      String
  email         String        @unique
  phone         String?
  address       String?
  city          String?
  postalCode    String?
  country       String?       @default("Deutschland")
  
  // Identification
  idType        String?       // Personalausweis, Reisepass, Führerschein
  idNumber      String?
  licenseNumber String?       // Führerscheinnummer
  licenseIssueDate DateTime?
  licenseExpiryDate DateTime?
  
  // Additional Info
  dateOfBirth   DateTime?
  nationality   String?
  company       String?       // For business customers
  taxId         String?       // For business customers
  
  // Customer Status
  isBlacklisted Boolean @default(false)
  blacklistReason String?
  customerType  String?       // Private, Business, VIP
  notes         String?

  // Auth (optional – for login/register)
  passwordHash  String?       // scrypt hash for dashboard login

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  rentals       Rental[]
  damageReports DamageRecord[]
}

model Rental {
  id            Int           @id @default(autoincrement())
  carId         Int
  customerId    Int
  
  // Rental Period
  startDate     DateTime
  endDate       DateTime
  actualReturnDate DateTime?
  
  // Pickup & Return
  pickupLocationId  Int?
  pickupLocation    Location?    @relation("PickupLocation", fields: [pickupLocationId], references: [id])
  returnLocationId  Int?
  returnLocation    Location?    @relation("ReturnLocation", fields: [returnLocationId], references: [id])
  pickupMileage  Int?
  returnMileage  Int?
  
  // Pricing
  dailyRate     Decimal
  totalDays     Int
  totalAmount   Decimal
  depositPaid   Decimal?
  depositReturned Decimal?
  
  // Additional Charges
  extraCharges  Decimal?      @default(0)
  extraChargesNote String?
  discountAmount Decimal?     @default(0)
  discountReason String?
  
  // Insurance & Extras
  insuranceType String?       // Vollkasko, Teilkasko, Basis
  insuranceCost Decimal?
  hasGPS        Boolean       @default(false)
  hasChildSeat  Boolean       @default(false)
  hasSkiRack    Boolean       @default(false)
  extrasCost    Decimal?      @default(0)
  
  // Fuel Policy
  fuelLevelPickup String?     // Full, 3/4, 1/2, 1/4, Empty
  fuelLevelReturn String?
  fuelCharge      Decimal?    @default(0)
  
  // Payment
  paymentStatus String        // Pending, Partial, Paid, Refunded
  paymentMethod String?       // Cash, Card, Transfer, Online
  
  // Status & Notes
  status        String        // Active, Completed, Pending, Cancelled
  contractNumber String?      @unique
  notes         String?
  damageReport  String?
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  car           Car           @relation(fields: [carId], references: [id])
  customer      Customer      @relation(fields: [customerId], references: [id])
  payments      Payment[]
  damageRecords DamageRecord[]
  invoices      Invoice[]
  fahrtenbuchEntries FahrtenbuchEntry[]
}

/// Rechnung pro Miete; Registrierkassa / Finanzamt (Österreich)
model Invoice {
  id                 Int      @id @default(autoincrement())
  rentalId           Int      @unique
  invoiceNumber      String   @unique // fortlaufende Belegnummer (z.B. RE-2026-00001)
  issuedAt           DateTime @default(now())
  
  // Beträge (zum Belegzeitpunkt)
  subtotal           Decimal  // Netto
  taxRate            Decimal  @default(20)   // USt % (Österreich z.B. 20)
  taxAmount          Decimal  // USt-Betrag
  total              Decimal  // Brutto
  
  status             String   @default("ISSUED") // DRAFT | ISSUED
  pdfPath            String?  // optional: gespeichertes PDF
  
  // Registrierkassa / BMF-Anbindung (später)
  registrierkassaExportedAt DateTime?  // wann an RKSV/BMF übermittelt
  registrierkassaBelegId    String?   // Beleg-ID von der Kasse
  
  createdAt          DateTime @default(now())
  
  rental             Rental   @relation(fields: [rentalId], references: [id])
}

model Payment {
  id            Int           @id @default(autoincrement())
  rentalId      Int
  
  amount        Decimal
  paymentMethod String        // Cash, Card, Transfer, Online
  paymentDate   DateTime      @default(now())
  
  transactionId String?
  notes         String?
  
  createdAt     DateTime      @default(now())
  
  rental        Rental        @relation(fields: [rentalId], references: [id])
}

model MaintenanceRecord {
  id            Int           @id @default(autoincrement())
  carId         Int
  
  maintenanceType String      // Oil Change, Tire Change, Inspection, Repair, Service
  description   String
  cost          Decimal?
  mileage       Int?
  
  performedBy   String?       // Workshop name or technician
  performedDate DateTime
  nextDueDate   DateTime?
  nextDueMileage Int?
  
  invoiceNumber String?
  notes         String?
  
  createdAt     DateTime      @default(now())
  
  car           Car           @relation(fields: [carId], references: [id])
}

model Notification {
  id            Int           @id @default(autoincrement())
  
  type          String        // Email, SMS, Push, System
  recipient     String        // Email or phone number
  subject       String?
  message       String
  
  status        String        // Pending, Sent, Failed
  sentAt        DateTime?
  errorMessage  String?
  
  // Related entities
  relatedType   String?       // Rental, Car, Customer, Payment
  relatedId     Int?
  
  createdAt     DateTime      @default(now())
}

model ActivityLog {
  id            Int           @id @default(autoincrement())
  
  userId        String?       // User who performed the action
  userName      String?
  action        String        // Created, Updated, Deleted, Viewed, etc.
  entityType    String        // Car, Rental, Customer, etc.
  entityId      Int?
  
  description   String        // Human-readable description
  metadata      String?       // JSON with additional details
  
  ipAddress     String?
  userAgent     String?
  
  createdAt     DateTime      @default(now())
}

model SystemSettings {
  id            Int           @id @default(autoincrement())
  key           String        @unique
  value         String
  description   String?
  category      String?       // General, Email, SMS, Payment, etc.
  
  updatedAt     DateTime      @updatedAt
  updatedBy     String?
}

model CompetitorPrice {
  id              Int      @id @default(autoincrement())
  carModel        String   // e.g. "BMW 320i", "VW Golf" - Araba modelini eşleştirmek için
  competitorName  String   // e.g. "Sixt", "Europcar", "Hertz"
  dailyRate       Decimal  // Günlük fiyat
  currency        String   @default("EUR")
  sourceUrl       String?  // Fiyatın alındığı kaynak URL
  fetchedAt       DateTime @default(now())
  
  // Opsiyonel: Bizim veritabanımızdaki bir araç kategorisi ile eşleştirme
  category        String?  // Kleinwagen, Limousine, SUV
  
  @@index([carModel])
  @@index([fetchedAt])
}
